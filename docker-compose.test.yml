services:
  test:
    build:
      context: .
      dockerfile: Dockerfile
    command: pytest tests/ -v --cov=app --cov-report=html --cov-report=term
    environment:
      - DATABASE_URL=postgresql+asyncpg://test:test@test-db:5432/testdb
      - GCP_PROJECT_ID=test-project
      - GCP_LOCATION=us-east1
      - SECURITY_SANITIZATION_ENABLED=true
      - SECURITY_PII_REDACTION_ENABLED=true
      - SECURITY_XSS_PROTECTION_ENABLED=true
      - SECURITY_SQL_INJECTION_DETECTION_ENABLED=true
      - SECURITY_COMMAND_INJECTION_DETECTION_ENABLED=true
      - SECURITY_LLM_CHECK_THRESHOLD=0.85
    volumes:
      - .:/app
      - /app/.venv
    depends_on:
      - test-db
    networks:
      - test-network

  test-db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_USER=test
      - POSTGRES_PASSWORD=test
      - POSTGRES_DB=testdb
    ports:
      - "5433:5432"
    networks:
      - test-network

networks:
  test-network:
    driver: bridge
