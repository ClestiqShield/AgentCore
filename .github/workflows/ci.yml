name: CD

on:
  push:
    branches: ["main", "staging"]
  workflow_dispatch:

jobs:
  build-and-health-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build all services
        run: docker compose build

      - name: Start all services
        run: docker compose up -d

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for all services to become healthy..."
          MAX_WAIT=300
          ELAPSED=0
          INTERVAL=5
          echo "Discovering container names..."
          GATEWAY_CONTAINER=$(docker compose ps -q gateway)
          SENTINEL_CONTAINER=$(docker compose ps -q sentinel)
          GUARDIAN_CONTAINER=$(docker compose ps -q guardian)
          DB_CONTAINER=$(docker compose ps -q db)
          echo "Container IDs found:"
          echo "  Gateway: $GATEWAY_CONTAINER"
          echo "  Sentinel: $SENTINEL_CONTAINER"
          echo "  Guardian: $GUARDIAN_CONTAINER"
          echo "  Database: $DB_CONTAINER"
          echo ""
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            echo "Checking service health (${ELAPSED}s elapsed)..."
            GATEWAY_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' $GATEWAY_CONTAINER 2>/dev/null || echo "no_healthcheck")
            SENTINEL_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' $SENTINEL_CONTAINER 2>/dev/null || echo "no_healthcheck")
            GUARDIAN_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' $GUARDIAN_CONTAINER 2>/dev/null || echo "no_healthcheck")
            DB_HEALTH=$(docker inspect --format='{{.State.Health.Status}}' $DB_CONTAINER 2>/dev/null || echo "no_healthcheck")
            echo "  Gateway: $GATEWAY_HEALTH"
            echo "  Sentinel: $SENTINEL_HEALTH"
            echo "  Guardian: $GUARDIAN_HEALTH"
            echo "  Database: $DB_HEALTH"
            if [ "$GATEWAY_HEALTH" = "healthy" ] && \
               [ "$SENTINEL_HEALTH" = "healthy" ] && \
               [ "$GUARDIAN_HEALTH" = "healthy" ] && \
               [ "$DB_HEALTH" = "healthy" ]; then
              echo "✅ All services are healthy!"
              exit 0
            fi
            if [ "$GATEWAY_HEALTH" = "unhealthy" ] || \
               [ "$SENTINEL_HEALTH" = "unhealthy" ] || \
               [ "$GUARDIAN_HEALTH" = "unhealthy" ] || \
               [ "$DB_HEALTH" = "unhealthy" ]; then
              echo "❌ One or more services are unhealthy!"
              docker compose ps
              docker compose logs
              exit 1
            fi
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          echo "❌ Timeout waiting for services to become healthy"
          docker compose ps
          docker compose logs
          exit 1

      - name: Verify service health endpoints
        run: |
          echo "Testing individual health endpoints..."
          echo "Testing Gateway health endpoint..."
          curl -f http://localhost:8000/health || (echo "Gateway health check failed" && exit 1)
          echo "✅ All health endpoints verified!"

      - name: Display service status
        if: success()
        run: |
          echo "========================================="
          echo "Service Status Summary"
          echo "========================================="
          docker compose ps
          echo ""
          echo "✅ All services built and health checks passed!"

      - name: Show logs on failure
        if: failure()
        run: |
          echo "========================================="
          echo "Service Logs (Last 100 lines)"
          echo "========================================="
          docker compose logs --tail=100

      - name: Authenticate to Google Cloud
        if: success()
        uses: google-github-actions/auth@v1
        with:
          credentials_json: "${{ secrets.GCP_SA_KEY }}"

      - name: Set up Cloud SDK
        if: success()
        uses: google-github-actions/setup-gcloud@v1

      - name: Create Artifact Registry Repository
        if: success()
        env:
          REPO: ${{ secrets.GCP_REPO }}
          REGION: ${{ secrets.GCP_REGION }}
        run: |
          if ! gcloud artifacts repositories describe $REPO --location=$REGION; then
            echo "Creating repository $REPO in $REGION..."
            gcloud artifacts repositories create $REPO \
              --repository-format=docker \
              --location=$REGION \
              --description="Docker repository for Clestiq Shield"
          else
            echo "Repository $REPO already exists."
          fi

      - name: Configure Docker for Artifact Registry
        if: success()
        run: gcloud auth configure-docker us-east1-docker.pkg.dev

      - name: Build and Push Images to Artifact Registry
        if: success()
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          REPO: ${{ secrets.GCP_REPO }}
          REGION: ${{ secrets.GCP_REGION }}
        run: |
          echo "Building and Pushing images..."

          # Gateway
          docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/gateway:${{ github.sha }} ./services/gateway
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/gateway:${{ github.sha }}
          # Also push 'latest' tag
          docker tag $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/gateway:${{ github.sha }} $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/gateway:latest
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/gateway:latest

          # Sentinel (Source is services/security-agent)
          docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/sentinel:${{ github.sha }} ./services/security-agent
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/sentinel:${{ github.sha }}
          docker tag $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/sentinel:${{ github.sha }} $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/sentinel:latest
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/sentinel:latest

          # Guardian
          docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/guardian:${{ github.sha }} ./services/guardian
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/guardian:${{ github.sha }}
          docker tag $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/guardian:${{ github.sha }} $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/guardian:latest
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/guardian:latest

          echo "✅ All images pushed successfully!"

      - name: Clean up
        if: always()
        run: |
          echo "Cleaning up Docker resources..."
          docker compose down -v
          echo "✅ Cleanup complete"
